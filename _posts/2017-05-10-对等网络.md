---
layout: post
title:  "P2P对等网络"
date:   2017-05-10 09:55:39 +0800
categories: 网络
---

# 对等网络

## 1. NAT穿透
在现实Internet网络环境中，大多数计算机主机都位于防火墙或NAT之后，只有少部分主机能够直接接入Internet。很多时候，我们希望网络中的两台主机能够直接进行通信，即所谓的P2P通信，而不需要其他公共服务器的中转。由于主机可能位于防火墙或NAT之后，在进行P2P通信之前，我们需要进行检测以确认它们之间能否进行P2P通信以及如何通信。这种技术通常称为NAT穿透（NAT Traversal）[1]

常见的NAT网络穿透方案有：
  1.  **STUN**: 简单的用UDP穿透NAT，客户端获取STUN服务器信息后，通过TCP协议向STUN服务器发送共享秘钥请求，STUN服务器生产共享秘钥响应。客户端和STUN服务器间使用共享私密，用作捆绑请求和捆绑响应中的密匙。之后，客户使用UDP协议向STUN服务器发送捆绑请求，当捆绑请求消息到达服务器的时候，它可能经过了一个或者多个NAT。客户端之间的通信就可以通过STUN服务器获取对端网络的IP地址和端口绑定，彼此通信。最大的优点是支持TCP穿透。
  2. **TURN**: 使用中继穿透NA，是STUN方案的扩展。如果一个主机位于NAT的后面，在某些情况下它不能够与其他主机点对点直接连接。在这些情况下，它需要使用中间网点提供的中继连接服务。TURN协议就是用来允许主机控制中继的操作并且使用中继与对端交换数据。TURN与其他中继控制协议不同的是它能够允许一个客户端使用一个中继地址与多个对端连接。不支持TCP穿透
  3. **UPnP**: 通用即插即用协议，STUN和TURN穿透方案都是通过“中间人”服务器实现点对点的通信。而UPnP不需要“中间人”服务器，通过UPnP-IGD协议实现点对点通信。但是需要在路由器网关等设备支持UPnP通信协议。

### 1.1 UPnP
UPnP 是各种各样的智能设备、无线设备和个人电脑等实现遍布全球的对等网络连接（P2P）的结构。UPnP 是一种分布式的，开放的网络架构。UPnP技术对即插即用进行了扩展，它简化了家庭或企业中智能设备的联网过程。在结合了UPnP技术的设备以物理形式连接到网络中之后，它们可以通过网络自动彼此连接在一起，而且连接过程无需用户的参与和使用中央服务器。  
UPnP在控制指针和被控制设备之间提供通讯功能。而网络介质、TCP/IP协议、HTTP仅提供基本的连接和IP地址分配。整个工作过程需要处理六个方面的内容，即设备寻址、发现设备、对设备的描述、设备控制、设备事件、设备表达。

#### 1.1.1 UPnP的NAT穿越技术
UPnP为NAT（网络地址转换）traversal带来了一个解决方案：IGD（Internet 网关设备） 协议。NAT traversal 允许UPnP数据包在没有用户交互的情况下，无障碍的通过路由器 或者 防火墙，（假如那个路由器 或者 防火墙 支持 NAT）。

#### 1.1.2 UPnP网络的安全问题
虽然UPnP的端口映射可以使用户的某些上网行为更加流畅，但由于设备被暴露到公网，导致了设备可以被公网恶意扫描访问到，同时Shodan、Zoomeye等网站也可以爬取到此类设备，因此大大提升了内网设备被恶意攻击利用的风险。[2]
UPnP协议默认没有实现任何鉴权认证机制，因此UPnP设备必须另外实现设备防护服务或者设备安全服务。也就不存在标准解决方案拓展UPnP设备或应用程序的用户鉴权认证机制。不幸的是，好多UPnP设备实现没有鉴权机制，假设本地系统和用户是完全信任的。[3]
如果没有实现鉴权认证机制，路由器和防火墙在运行UPnP-IGD协议时就容易受到攻击。[4]


## 2. RLPx
RLP(Recursive Length Prefix encoding)递归长度前缀编码[5]，是Ethereum中对象序列化的一个主要的编码方式，其目的是对任意嵌套的二进制数据的序列进行编码。

RLPx: 是一个加密对等网络传输协议套件[6] ，为应用程序通过p2p网络通信提供通用的传输通道和接口，旨在满足分散应用程序的要求。

特性：
- 发现节点和网络的形成
- 加密的握手
- 加密传输
- 协议Mux(框架)
- 流控制
- 对等优先策略
- 同行的声誉
- 安全
  - 身份验证的连接(ECDH + ECDHE AES128)
  - 经过验证发现协议(ECDSA)
  - 加密传输(AES256)
  - 协议共享一个连接提供了统一的带宽(框架)
  - 节点使用一个统一的网络拓扑
  - 对端可以统一连接到网络
  - 局部的同行的声誉模型


## 3. Kademlia算法

Kademlia是一种通过分散式杂凑表实现的协议算法，它是由Petar和David为非集中式P2P计算机网络而设计的。Kademlia规定了网络的结构，也规定了通过节点查询进行信息交换的方式。Kademlia网络节点之间使用UDP进行通讯。参与通讯的所有节点形成一张虚拟网（或者叫做覆盖网）。这些节点通过一组数字（或称为节点ID）来进行身份标识。节点ID不仅可以用来做身份标识，还可以用来进行值定位（值通常是文件的散列或者关键词）。其实，节点ID与文件散列直接对应，它所表示的那个节点存储着哪儿能够获取文件和资源的相关信息。当我们在网络中搜索某些值（即通常搜索存储文件散列或关键词的节点）的时候，Kademlia算法需要知道与这些值相关的键，然后分步在网络中开始搜索。每一步都会找到一些节点，这些节点的ID与键更为接近，如果有节点直接返回搜索的值或者再也无法找到与键更为接近的节点ID的时候搜索便会停止。

Kad网络中的每一个节点均拥有一个专属ID，该ID的具体形式与SHA1散列值类似，为一个长达160bit的整数，它是由节点自己随机生成的， 两个节点拥有同一ID的可能性非常之小，因此可以认为这几乎是不可能的。  

P2P网络的演进：  
- 第一代P2P文件分享网络，像Napster，依赖于中央数据库来协调网络中的查询。
- 第二代P2P网络，像Gnutella，使用泛滥式查询（query flooding）来查询文件，它会搜索网络中的所有节点。
- 第三代p2p网络使用分散式杂凑表来查询网络中的文件，分散式杂凑表在整个网络中储存资源的位置，这些协议追求的主要目标就是快速定位期望的节点。[7]  

Kademlia基于两个节点之间的距离计算，该距离是两个网络节点ID号的异或，计算的结果最终作为整型数值返回。关键字和节点ID有同样的格式和长度，因此，可以使用同样的方法计算关键字和节点ID之间的距离。节点ID一般是一个大的随机数，选择该数的时候所追求的一个目标就是它的唯一性（希望在整个网络中该节点ID是唯一的）。异或距离跟实际上的地理位置没有任何关系，只与ID相关。因此很可能来自德国和澳大利亚的节点由于选择了相似的随机ID而成为邻居。选择异或是因为通过它计算的距离享有几何距离公式的一些特征，尤其体现在以下几点：节点和它本身之间的异或距离是0；异或距离是对称的：即从A到B的异或距离与从B到A的异或距离是等同的；异或距离符合三角不等式：三个顶点A B C，AC异或距离小于或等于AB异或距离和BC异或距离之和。由于以上的这些属性，在实际的节点距离的度量过程中计算量将大大降低。Kademlia搜索的每一次迭代将距目标至少更近1 bit。一个基本的具有2的n次方个节点的Kademlia网络在最坏的情况下只需花n步就可找到被搜索的节点或值。  

### 3.1 Kademlia路由表  
Kademlia路由表由多个列表组成，每个列表对应节点ID的一位（例如：假如节点ID共有128位，则节点的路由表将包含128个列表），包含多个条目，条目中包含定位其他节点所必要的一些数据。列表条目中的这些数据通常是由其他节点的IP地址，端口和节点ID组成。每个列表对应于与节点相距特定范围距离的一些节点，节点的第n个列表中所找到的节点的第n位与该节点的第n位肯定不同，而前n-1位相同，这就意味着很容易使用网络中远离该节点的一半节点来填充第一个列表（第一位不同的节点最多有一半），而用网络中四分之一的节点来填充第二个列表（比第一个列表中的那些节点离该节点更近一位），依次类推。如果ID有128个二进制位，则网络中的每个节点按照不同的异或距离把其他所有的节点分成了128类，ID的每一位对应于其中的一类。随着网络中的节点被某节点发现，它们被逐步加入到该节点的相应的列表中，这个过程中包括向节点列表中存信息和从节点列表中取信息的操作，甚至还包括当时协助其他节点寻找相应键对应值的操作。这个过程中发现的所有节点都将被加入到节点的列表之中，因此节点对整个网络的感知是动态的，这使得网络一直保持着频繁地更新，增强了抵御错误和攻击的能力。

列表也称为K桶，其中K是一个系统变量，如20，每一个K桶是一个最多包含K个条目的列表，也就是说，网络中所有节点的一个列表（对应于某一位，与该节点相距一个特定的距离）最多包含20个节点。随着对应的bit位变低（即对应的异或距离越来越短），K桶包含的可能节点数迅速下降（这是由于K桶对应的异或距离越近，节点数越少），因此，对应于更低bit位的K桶显然包含网络中所有相关部分的节点。由于网络中节点的实际数量远远小于可能ID号的数量，所以对应那些短距离的某些K桶可能一直是空的（如果异或距离只有1，可能的数量就最大只能为1，这个异或距离为1的节点如果没有发现，则对应于异或距离为1的K桶则是空的）。

让我们看右边的那个简单网络，该网络最大可有2^3，即8个关键字和节点，目前共有7个节点加入，每个节点用一个小圈表示（在树的底部）。我们考虑那个用黑圈标注的节点6，它共有3个K桶，节点0，1和2（二进制表示为000，001和010）是第一个K桶的候选节点，节点3目前（二进制表示为011）还没有加入网络，节点4和节点5（二进制表示分别为100和101）是第二个K桶的候选节点，只有节点7（二进制表示为111）是第3个K桶的候选节点。图中，3个K桶都用灰色圈表示，假如K桶的大小（即K值）是2，那么第一个K桶只能包含3个节点中的2个。众所周知，那些长时间在线连接的节点未来长时间在线的可能性更大，基于这种静态统计分布的规律，Kademlia选择把那些长时间在线的节点存入K桶，这一方法增长了未来某一时刻有效节点的数量，同时也提供了更为稳定的网络。当某个K桶已满，而又发现了相应于该桶的新节点的时候，那么，就首先检查K桶中最早访问的节点，假如该节点仍然存活，那么新节点就被安排到一个附属列表中（作为一个替代缓存）.只有当K桶中的某个节点停止响应的时候，替代cache才被使用。换句话说，新发现的节点只有在老的节点消失后才被使用。  
![DHT](/images/Dht_example_SVG.svg)

### 3.2 Kademlia协议
- **PING** 用来测试节点是否仍然在线
- **STORE** 在某个节点中存储一个键值对
- **FIND_NODE** 消息请求的接收者将返回自己桶中离请求键值最近的K个节点
- **FIND_VALUE** 当请求的接收者存有请求者所请求的键的时候，它将返回相应键的值


## 4. UPnP协议

### 4.1 协议：
**SSDP**: (Simple Service Discovery Protocol，简单服务发现协议)，发现本地网络上的UPnP设备  
**SCPD**: (Service Control Point Definition,服务控制端点定义)，定义各种服务执行动作  
**SOAP**: (Simple Object Access Protocol,简单对象访问协议)，执行动作[8]

UPnP回话流程：  
    ![UPnP](/images/upnp_overview.png)  
使用SSDP发现网络上可用的设备,这些设备返回一个定义了每个设备所提供服务的XML文件的位置。接下来,使用SCPD发现每个服务提供的动作。从本质上讲,SCPD是描述一个基于xml的SOAP api的协议。最后,我们使用SOAP调用与服务交互。

### 4.1.1 网络发现
python模拟代码test.py文件内容[8]：
```python
import socket

msg = \
    'M-SEARCH * HTTP/1.1\r\n' \
    'HOST:239.255.255.250:1900\r\n' \
    'ST:upnp:rootdevice\r\n' \
    'MX:2\r\n' \
    'MAN:"ssdp:discover"\r\n'

# Set up UDP socket
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
s.settimeout(2)
s.sendto(msg, ('239.255.255.250', 1900) )

try:
    while True:
        data, addr = s.recvfrom(65507)
        print addr, data
except socket.timeout:
    pass
```
命令行执行脚本：
```bash
# python test.py
('192.168.0.1', 1900) HTTP/1.1 200 OK
CACHE-CONTROL: max-age=60
DATE: Wed, 03 May 2017 05:29:13 GMT
EXT:
LOCATION: http://192.168.0.1:1900/igd.xml
SERVER: vxWorks/5.5 UPnP/1.0 TL-WR842N/8.0
ST: upnp:rootdevice
USN: uuid:8c15e41f-3d83-41c1-b35d-5D2A648FD020::upnp:rootdevice
```
tcpdump抓包报文：
```
# sudo tcpdump -i enp0s3 -Avvvn 'udp and port 1900'
13:29:13.794476 IP (tos 0x0, ttl 1, id 58129, offset 0, flags [DF], proto UDP (17), length 123)
    192.168.0.117.37768 > 239.255.255.250.1900: [bad udp cksum 0xb190 -> 0xe37a!] UDP, length 95
E..{..@....H...u.......l.g..M-SEARCH * HTTP/1.1
HOST:239.255.255.250:1900
ST:upnp:rootdevice
MX:2
MAN:"ssdp:discover"

13:29:13.796616 IP (tos 0x0, ttl 64, id 13827, offset 0, flags [none], proto UDP (17), length 290)
    192.168.0.1.1900 > 192.168.0.117.37768: [udp sum ok] UDP, length 262
E.."6...@..........u.l......HTTP/1.1 200 OK
CACHE-CONTROL: max-age=60
DATE: Wed, 03 May 2017 05:29:13 GMT
EXT:
LOCATION: http://192.168.0.1:1900/igd.xml
SERVER: vxWorks/5.5 UPnP/1.0 TL-WR842N/8.0
ST: upnp:rootdevice
USN: uuid:8c15e41f-3d83-41c1-b35d-5D2A648FD020::upnp:rootdevice
```
下载设备描述文件igd.xml：
``` bash
# wget  http://192.168.0.1:1900/igd.xml
# cat igd.xml
```
浏览igd.xml文件：
```xml
<?xml version="1.0"?>
<root xmlns="urn:schemas-upnp-org:device-1-0">
    <specVersion>
        <major>1</major>
        <minor>0</minor>
    </specVersion>
    <device>
        <deviceType>urn:schemas-upnp-org:device:InternetGatewayDevice:1</deviceType>
        <presentationURL>http://192.168.0.1:80</presentationURL>
        <friendlyName>Wireless N Router TL-WR842N</friendlyName>
        <manufacturer>TP-LINK</manufacturer>
        <manufacturerURL>http://www.tp-link.com.cn</manufacturerURL>
        <modelDescription>TL-WR842N 8.0</modelDescription>
        <modelName>TL-WR842N</modelName>
        <modelNumber>8.0</modelNumber>
        <UDN>uuid:8c15e41f-3d83-41c1-b35d-5D2A648FD020</UDN>
        <UPC>123456789001</UPC>
        <serviceList>
            <service>
                <serviceType>urn:schemas-upnp-org:service:Layer3Forwarding:1</serviceType>
                <serviceId>urn:upnp-org:serviceId:L3Forwarding1</serviceId>
                <controlURL>/l3f</controlURL>
                <eventSubURL>/l3f</eventSubURL>
                <SCPDURL>/l3f.xml</SCPDURL>
            </service>
        </serviceList>
        <deviceList>
            <device>
                <deviceType>urn:schemas-upnp-org:device:WANDevice:1</deviceType>
                <friendlyName>WAN Device</friendlyName>
                <manufacturer>TP-LINK</manufacturer>
                <manufacturerURL>http://www.tp-link.com.cn</manufacturerURL>
                <modelDescription>WAN Device</modelDescription>
                <modelName>WAN Device</modelName>
                <modelNumber>1.0</modelNumber>
                <modelURL></modelURL>
                <serialNumber>12345678900001</serialNumber>
                <UDN>uuid:8c15e41f-3d83-41c1-b35d-5D2A648FD020</UDN>
                <UPC>123456789001</UPC>
                <serviceList>
                    <service>
                        <serviceType>urn:schemas-upnp-org:service:WANCommonInterfaceConfig:1</serviceType>
                        <serviceId>urn:upnp-org:serviceId:WANCommonInterfaceConfig</serviceId>
                        <controlURL>/ifc</controlURL>
                        <eventSubURL>/ifc</eventSubURL>
                        <SCPDURL>/ifc.xml</SCPDURL>
                    </service>
                </serviceList>
                <deviceList>
                    <device>
                        <deviceType>urn:schemas-upnp-org:device:WANConnectionDevice:1</deviceType>
                        <friendlyName>WAN Connection Device</friendlyName>
                        <manufacturer>TP-LINK</manufacturer>
                        <manufacturerURL>http://www.tp-link.com.cn</manufacturerURL>
                        <modelDescription>WAN Connection Device</modelDescription>
                        <modelName>WAN Connection Device</modelName>
                        <modelNumber>1</modelNumber>
                        <modelURL></modelURL>
                        <serialNumber>12345678900001</serialNumber>
                        <UDN>uuid:8c15e41f-3d83-41c1-b35d-5D2A648FD020</UDN>
                        <UPC>123456789001</UPC>
                        <serviceList>
                            <service>
                                <serviceType>urn:schemas-upnp-org:service:WANIPConnection:1</serviceType>
                                <serviceId>urn:upnp-org:serviceId:WANIPConnection</serviceId>
                                <controlURL>/ipc</controlURL>
                                <eventSubURL>/ipc</eventSubURL>
                                <SCPDURL>/ipc.xml</SCPDURL>
                            </service>
                        </serviceList>
                    </device>
                </deviceList>
            </device>
        </deviceList>
    </device>
</root>
```
得到设备所提供的服务描述,在刚才的设备描述中有一个ServiceList节点，该节点下每个Service节点都包含一个SCPDURL节点，这个就是服务描述文件所在的位置[9].

第三层转发配置文件：
```bash
#  wget  http://192.168.0.1:1900/l3f.xml
# cat l3f.xml
```
浏览服务描述文件l3f.xml:
```xml
<?xml version="1.0"?>
<scpd xmlns="urn:schemas-upnp-org:service-1-0">
    <specVersion>
        <major>1</major>
        <minor>0</minor>
    </specVersion>
    <actionList>
        <action>
            <name>SetDefaultConnectionService</name>
            <argumentList>
                <argument>
                    <name>NewDefaultConnectionService</name>
                    <direction>in</direction>
                    <relatedStateVariable>DefaultConnectionService</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetDefaultConnectionService</name>
            <argumentList>
                <argument>
                    <name>NewDefaultConnectionService</name>
                    <direction>out</direction>
                    <relatedStateVariable>DefaultConnectionService</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
    </actionList>
    <serviceStateTable>
        <stateVariable sendEvents="yes">
            <name>DefaultConnectionService</name>
            <dataType>string</dataType>
        </stateVariable>
    </serviceStateTable>
</scpd>
```


广域网公共接口配置描述文件：
```bash
# wget  http://192.168.0.1:1900/ifc.xml
# cat ifc.xml
```
浏览描述文件ifc.xml:
```xml
<?xml version="1.0"?>
<scpd xmlns="urn:schemas-upnp-org:service-1-0">
    <specVersion>
        <major>1</major>
        <minor>0</minor>
    </specVersion>
    <actionList>
        <action>
            <name>GetCommonLinkProperties</name>
            <argumentList>
                <argument>
                    <name>NewWANAccessType</name>
                    <direction>out</direction>
                    <relatedStateVariable>WANAccessType</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewLayer1UpstreamMaxBitRate</name>
                    <direction>out</direction>
                    <relatedStateVariable>Layer1UpstreamMaxBitRate</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewLayer1DownstreamMaxBitRate</name>
                    <direction>out</direction>
                    <relatedStateVariable>Layer1DownstreamMaxBitRate</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewPhysicalLinkStatus</name>
                    <direction>out</direction>
                    <relatedStateVariable>PhysicalLinkStatus</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetTotalBytesSent</name>
            <argumentList>
                <argument>
                    <name>NewTotalBytesSent</name>
                    <direction>out</direction>
                    <relatedStateVariable>TotalBytesSent</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetTotalBytesReceived</name>
            <argumentList>
                <argument>
                    <name>NewTotalBytesReceived</name>
                    <direction>out</direction>
                    <relatedStateVariable>TotalBytesReceived</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetTotalPacketsSent</name>
            <argumentList>
                <argument>
                    <name>NewTotalPacketsSent</name>
                    <direction>out</direction>
                    <relatedStateVariable>TotalPacketsSent</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetTotalPacketsReceived</name>
            <argumentList>
                <argument>
                    <name>NewTotalPacketsReceived</name>
                    <direction>out</direction>
                    <relatedStateVariable>TotalPacketsReceived</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
    </actionList>
    <serviceStateTable>
        <stateVariable sendEvents="no">
            <name>WANAccessType</name>
            <dataType>string</dataType>
            <allowedValueList>
                <allowedValue>DSL</allowedValue>
                <allowedValue>POTS</allowedValue>
                <allowedValue>Cable</allowedValue>
                <allowedValue>Ethernet</allowedValue>
                <allowedValue>Other</allowedValue>
            </allowedValueList>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>Layer1UpstreamMaxBitRate</name>
            <dataType>ui4</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>Layer1DownstreamMaxBitRate</name>
            <dataType>ui4</dataType>
        </stateVariable>
        <stateVariable sendEvents="yes">
            <name>PhysicalLinkStatus</name>
            <dataType>string</dataType>
            <allowedValueList>
                <allowedValue>Up</allowedValue>
                <allowedValue>Down</allowedValue>
                <allowedValue>Initializing</allowedValue>
                <allowedValue>Unavailable</allowedValue>
            </allowedValueList>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>MaximumActiveConnections</name>
            <dataType>ui2</dataType>
            <allowedValueRange>
                <minimum>1</minimum>
                <maximum>2</maximum>
                <step>1</step>
            </allowedValueRange>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>TotalBytesSent</name>
            <dataType>ui4</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>TotalBytesReceived</name>
            <dataType>ui4</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>TotalPacketsSent</name>
            <dataType>ui4</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>TotalPacketsReceived</name>
            <dataType>ui4</dataType>
        </stateVariable>
    </serviceStateTable>
</scpd>
```
广域网网络连接描述文件：
```
# wget  http://192.168.0.1:1900/ipc.xml
# cat ipc.xml
```
浏览ipc.xml文件：
```xml
<?xml version="1.0"?>
<scpd xmlns="urn:schemas-upnp-org:service-1-0">
    <specVersion>
        <major>1</major>
        <minor>0</minor>
    </specVersion>
    <actionList>
        <action>
            <name>SetConnectionType</name>
            <argumentList>
                <argument>
                    <name>NewConnectionType</name>
                    <direction>in</direction>
                    <relatedStateVariable>ConnectionType</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetConnectionTypeInfo</name>
            <argumentList>
                <argument>
                    <name>NewConnectionType</name>
                    <direction>out</direction>
                    <relatedStateVariable>ConnectionType</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewPossibleConnectionTypes</name>
                    <direction>out</direction>
                    <relatedStateVariable>PossibleConnectionTypes</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>ForceTermination</name>
        </action>
        <action>
            <name>RequestConnection</name>
        </action>
        <action>
            <name>GetStatusInfo</name>
            <argumentList>
                <argument>
                    <name>NewConnectionStatus</name>
                    <direction>out</direction>
                    <relatedStateVariable>ConnectionStatus</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewLastConnectionError</name>
                    <direction>out</direction>
                    <relatedStateVariable>LastConnectionError</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewUptime</name>
                    <direction>out</direction>
                    <relatedStateVariable>Uptime</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetNATRSIPStatus</name>
            <argumentList>
                <argument>
                    <name>NewRSIPAvailable</name>
                    <direction>out</direction>
                    <relatedStateVariable>RSIPAvailable</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewNATEnabled</name>
                    <direction>out</direction>
                    <relatedStateVariable>NATEnabled</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetGenericPortMappingEntry</name>
            <argumentList>
                <argument>
                    <name>NewPortMappingIndex</name>
                    <direction>in</direction>
                    <relatedStateVariable>PortMappingNumberOfEntries</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewRemoteHost</name>
                    <direction>out</direction>
                    <relatedStateVariable>RemoteHost</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewExternalPort</name>
                    <direction>out</direction>
                    <relatedStateVariable>ExternalPort</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewProtocol</name>
                    <direction>out</direction>
                    <relatedStateVariable>PortMappingProtocol</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewInternalPort</name>
                    <direction>out</direction>
                    <relatedStateVariable>InternalPort</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewInternalClient</name>
                    <direction>out</direction>
                    <relatedStateVariable>InternalClient</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewEnabled</name>
                    <direction>out</direction>
                    <relatedStateVariable>PortMappingEnabled</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewPortMappingDescription</name>
                    <direction>out</direction>
                    <relatedStateVariable>PortMappingDescription</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewLeaseDuration</name>
                    <direction>out</direction>
                    <relatedStateVariable>PortMappingLeaseDuration</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetSpecificPortMappingEntry</name>
            <argumentList>
                <argument>
                    <name>NewRemoteHost</name>
                    <direction>in</direction>
                    <relatedStateVariable>RemoteHost</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewExternalPort</name>
                    <direction>in</direction>
                    <relatedStateVariable>ExternalPort</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewProtocol</name>
                    <direction>in</direction>
                    <relatedStateVariable>PortMappingProtocol</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewInternalPort</name>
                    <direction>out</direction>
                    <relatedStateVariable>InternalPort</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewInternalClient</name>
                    <direction>out</direction>
                    <relatedStateVariable>InternalClient</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewEnabled</name>
                    <direction>out</direction>
                    <relatedStateVariable>PortMappingEnabled</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewPortMappingDescription</name>
                    <direction>out</direction>
                    <relatedStateVariable>PortMappingDescription</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewLeaseDuration</name>
                    <direction>out</direction>
                    <relatedStateVariable>PortMappingLeaseDuration</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>AddPortMapping</name>
            <argumentList>
                <argument>
                    <name>NewRemoteHost</name>
                    <direction>in</direction>
                    <relatedStateVariable>RemoteHost</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewExternalPort</name>
                    <direction>in</direction>
                    <relatedStateVariable>ExternalPort</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewProtocol</name>
                    <direction>in</direction>
                    <relatedStateVariable>PortMappingProtocol</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewInternalPort</name>
                    <direction>in</direction>
                    <relatedStateVariable>InternalPort</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewInternalClient</name>
                    <direction>in</direction>
                    <relatedStateVariable>InternalClient</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewEnabled</name>
                    <direction>in</direction>
                    <relatedStateVariable>PortMappingEnabled</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewPortMappingDescription</name>
                    <direction>in</direction>
                    <relatedStateVariable>PortMappingDescription</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewLeaseDuration</name>
                    <direction>in</direction>
                    <relatedStateVariable>PortMappingLeaseDuration</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>DeletePortMapping</name>
            <argumentList>
                <argument>
                    <name>NewRemoteHost</name>
                    <direction>in</direction>
                    <relatedStateVariable>RemoteHost</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewExternalPort</name>
                    <direction>in</direction>
                    <relatedStateVariable>ExternalPort</relatedStateVariable>
                </argument>
                <argument>
                    <name>NewProtocol</name>
                    <direction>in</direction>
                    <relatedStateVariable>PortMappingProtocol</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
        <action>
            <name>GetExternalIPAddress</name>
            <argumentList>
                <argument>
                    <name>NewExternalIPAddress</name>
                    <direction>out</direction>
                    <relatedStateVariable>ExternalIPAddress</relatedStateVariable>
                </argument>
            </argumentList>
        </action>
    </actionList>
    <serviceStateTable>
        <stateVariable sendEvents="no">
            <name>ConnectionType</name>
            <dataType>string</dataType>
        </stateVariable>
        <stateVariable sendEvents="yes">
            <name>PossibleConnectionTypes</name>
            <dataType>string</dataType>
            <allowedValueList>
                <allowedValue>Unconfigured</allowedValue>
                <allowedValue>IP_Routed</allowedValue>
                <allowedValue>IP_Bridged</allowedValue>
            </allowedValueList>
        </stateVariable>
        <stateVariable sendEvents="yes">
            <name>ConnectionStatus</name>
            <dataType>string</dataType>
            <defaultValue>Unconfigured</defaultValue>
            <allowedValueList>
                <allowedValue>Unconfigured</allowedValue>
                <allowedValue>Connected</allowedValue>
                <allowedValue>Disconnected</allowedValue>
            </allowedValueList>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>Uptime</name>
            <dataType>ui4</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>LastConnectionError</name>
            <dataType>string</dataType>
            <allowedValueList>
                <allowedValue>ERROR_NONE</allowedValue>
                <allowedValue>ERROR_UNKNOWN</allowedValue>
            </allowedValueList>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>RSIPAvailable</name>
            <dataType>boolean</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>NATEnabled</name>
            <dataType>boolean</dataType>
        </stateVariable>
        <stateVariable sendEvents="yes">
            <name>ExternalIPAddress</name>
            <dataType>string</dataType>
        </stateVariable>
        <stateVariable sendEvents="yes">
            <name>PortMappingNumberOfEntries</name>
            <dataType>ui2</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>PortMappingEnabled</name>
            <dataType>boolean</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>PortMappingLeaseDuration</name>
            <dataType>ui4</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>RemoteHost</name>
            <dataType>string</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>ExternalPort</name>
            <dataType>ui2</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>InternalPort</name>
            <dataType>ui2</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>PortMappingProtocol</name>
            <dataType>string</dataType>
            <allowedValueList>
                <allowedValue>TCP</allowedValue>
                <allowedValue>UDP</allowedValue>
            </allowedValueList>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>InternalClient</name>
            <dataType>string</dataType>
        </stateVariable>
        <stateVariable sendEvents="no">
            <name>PortMappingDescription</name>
            <dataType>string</dataType>
        </stateVariable>
    </serviceStateTable>
</scpd>
```
ipc.xml文件中定义了soap api,发起一个soap service调用：
```Python
import urllib2

soap_body = """
<!--?xml version="1.0"?-->
<s:envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingstyle="http://schemas.xmlsoap.org/soap/encoding/">
    <s:body>
        <u:GetExternalIPAddress xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1">
        </u:GetExternalIPAddress>
    </s:body>
</s:envelope>   
"""

soap_action = "urn:schemas-upnp-org:service:WANIPConnection:1#GetExternalIPAddress"
headers = {
    'SOAPAction': u'"%s"' % (soap_action),
    'Host': u'192.168.0.1:1900',
    'Content-Type': 'text/xml',
    'Content-Length': len(soap_body),
}

ctrl_url = "http://192.168.0.1:1900/ipc"

request = urllib2.Request(ctrl_url, soap_body, headers)
response = urllib2.urlopen(request)

print response.read()
```
执行脚本：
```
# python soap_call.py
```
执行返回结果：
```xml
<?xml version="1.0"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
    <s:Body>
        <u:GetExternalIPAddressResponse xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1">
            <NewExternalIPAddress>100.64.172.239</NewExternalIPAddress>
        </u:GetExternalIPAddressResponse>
    </s:Body>
</s:Envelope>
```
tcpdump抓取报文：
```
18:24:53.487269 IP (tos 0x0, ttl 64, id 9843, offset 0, flags [DF], proto TCP (6), length 60)
sackOK,TS val 7356036 ecr 0,nop,wscale 7], length 0
E..<&s@.@......u.....f.lz.........r............
.p>.........
18:24:53.487756 IP (tos 0x0, ttl 64, id 37392, offset 0, flags [DF], proto TCP (6), length 60)
1460,nop,wscale 0,nop,nop,TS val 46794066 ecr 7356036], length 0
E..<..@.@.&........u.l.f.U..z.....@..d.............
...R.p>.
18:24:53.487780 IP (tos 0x0, ttl 64, id 9844, offset 0, flags [DF], proto TCP (6), length 52)
l 7356036 ecr 46794066], length 0
E..4&t@.@......u.....f.lz....U.............
.p>....R
18:24:53.488790 IP (tos 0x0, ttl 64, id 9845, offset 0, flags [DF], proto TCP (6), length 624)
TS val 7356036 ecr 46794066], length 572
E..p&u@.@..L...u.....f.lz....U.......).....
.p>....RPOST /ipc HTTP/1.1
Accept-Encoding: identity
Content-Length: 321
Soapaction: "urn:schemas-upnp-org:service:WANIPConnection:1#GetExternalIPAddress"
Connection: close
User-Agent: Python-urllib/2.7
Host: 192.168.0.1:1900
Content-Type: text/xml


<!--?xml version="1.0"?-->
<s:envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingstyle="http://schemas.xmlsoap.org/soap/encoding/">
    <s:body>
        <u:GetExternalIPAddress xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1">
        </u:GetExternalIPAddress>
    </s:body>
</s:envelope>   

18:24:53.497455 IP (tos 0x0, ttl 64, id 37393, offset 0, flags [DF], proto TCP (6), length 218)
6794066 ecr 7356036], length 166
E.....@.@.&F.......u.l.f.U..z..4..@........
...R.p>.HTTP/1.1 200 OK
Content-Type: text/xml;charset=UTF-8
Content-Length: 360
Connection: close
Cache-control: no-cache
Server: vxWorks/5.5 UPnP/1.0 TL-WR842N/8.0


18:24:53.497788 IP (tos 0x0, ttl 64, id 9846, offset 0, flags [DF], proto TCP (6), length 52)
S val 7356039 ecr 46794066], length 0
E..4&v@.@......u.....f.lz..4.U.{...........
.p>....R
18:24:53.498268 IP (tos 0x0, ttl 64, id 37394, offset 0, flags [DF], proto TCP (6), length 412)
 46794066 ecr 7356036], length 360
E.....@.@.%........u.l.f.U.{z..4..@.b......
...R.p>.<?xml version="1.0"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body><u:GetExternalIPAddressResponse xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1"><NewExternalIPAddress>100.64.172.239</NewExternalIPAddress></u:GetExternalIPAddressResponse></s:Body></s:Envelope>

18:24:53.498272 IP (tos 0x0, ttl 64, id 37395, offset 0, flags [DF], proto TCP (6), length 52)
94066 ecr 7356036], length 0
E..4..@.@.&........u.l.f.U..z..4..@........
...R.p>.
18:24:53.498509 IP (tos 0x0, ttl 64, id 9847, offset 0, flags [DF], proto TCP (6), length 52)
S val 7356039 ecr 46794066], length 0
E..4&w@.@......u.....f.lz..4.U.............
.p>....R
18:24:53.498666 IP (tos 0x0, ttl 64, id 9848, offset 0, flags [DF], proto TCP (6), length 52)
TS val 7356039 ecr 46794066], length 0
E..4&x@.@......u.....f.lz..4.U.............
.p>....R
18:24:53.499362 IP (tos 0x0, ttl 64, id 37396, offset 0, flags [DF], proto TCP (6), length 52)
4066 ecr 7356039], length 0
E..4..@.@.&........u.l.f.U..z..5..?........
...R.p>.
```

[1]: http://www.h3c.com.cn/MiniSite/Technology_Circle/Net_Reptile/The_Five/Home/Catalog/201206/747038_97665_0.htm "STUN和TURN技术浅析"
[2]: http://www.tuicool.com/articles/MJVzey7 "UPnP 端口映射安全浅析"
[3]: https://en.wikipedia.org/wiki/Universal_Plug_and_Play "Universal Plug and Play wikipedia"
[4]: http://www.academia.edu/3186292/A_UPnP_extension_for_enabling_user_authentication_and_authorization_in_pervasive_systems "A UPnP extension for enabling user authentication and authorization in pervasive systems"
[5]: https://github.com/ethereum/wiki/wiki/RLP "RLP"
[6]: https://github.com/ethereum/devp2p/blob/master/rlpx.md "RLPx"
[7]: https://zh.wikipedia.org/wiki/Kademlia "Kademlia"
[8]: https://www.electricmonk.nl/log/2016/07/05/exploring-upnp-with-python/ "Exploring UPnP with Python"
[9]: http://www.mikewootc.com/wiki/net/protocol/upnp_netpacket_example.html "upnp交互网络包示例"
