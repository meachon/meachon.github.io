---
layout: post
title:  "以太坊智能合约"
date:   2017-05-10 09:55:39 +0800
categories: 数字货币
---


# 智能合约与区块链的关系

尼克•萨博关于智能合约的工作理论迟迟没有实现，一个重要原因是因为缺乏能够支持可编程合约的数字系统和技术。区块链技术的出现解决了该问题，不仅可以支持可编程合约，而且具有去中心化、不可篡改、过程透明可追踪等优点，天然适合于智能合约。因此，也可以说，智能合约是区块链技术的特性之一。  

如果说区块链1.0是以比特币为代表，解决了货币和支付手段的去中心化问题，那么区块链2.0就是更宏观的对整个市场去中心化，利用区块链技术来转换许多不同的数字资产而不仅仅是比特币，通过转让来创建不同资产的价值。区块链技术的去中心化账本功能可以被用来创建、确认、转移各种不同类型的资产及合约。几乎所有类型的金融交易都可以被改造成在区块链上使用，包括股票、私募股权、众筹、债券和其他类型的金融衍生品如期货、期权等。

智能合约看上去就是一段计算机执行程序，满足可准确自动执行即可，那么为什么用传统的技术为何很难实现，而需要区块链技术等新技术呢？传统技术即使通过软件限制、性能优化等方法，也无法同时实现区块链的特性：
  1. 是数据无法删除、修改，只能新增，保证了历史的可追溯，同时作恶的成本将很高，因为其作恶行为将被永远记录；
  2. 是去中心化，避免了中心化因素的影响。

基于区块链技术的智能合约不仅可以发挥智能合约在成本效率方面的优势，而且可以避免恶意行为对合约正常执行的干扰。将智能合约以数字化的形式写入区块链中，由区块链技术的特性保障存储、读取、执行整个过程透明可跟踪、不可攥改。同时，由区块链自带的共识算法构建出一套状态机系统，使得智能合约能够高效地运行。

# 智能合约工作原理
基于区块链的智能合约包括事务处理和保存的机制，以及一个完备的状态机，用于接受和处理各种智能合约；并且事务的保存和状态处理都在区块链上完成。事务主要包含需要发送的数据；而事件则是对这些数据的描述信息。事务及事件信息传入智能合约后，合约资源集合中的资源状态会被更新，进而触发智能合约进行状态机判断。如果自动状态机中某个或某几个动作的触发条件满足，则由状态机根据预设信息选择合约动作自动执行。

智能合约系统根据事件描述信息中包含的触发条件，当触发条件满足时，从智能合约自动发出预设的数据资源，以及包括触发条件的事件；整个智能合约系统的核心就在于智能合约以事务和事件的方式经过智能合约模块的处理，出去还是一组事务和事件；智能合约只是一个事务处理模块和状态机构成的系统，它不产生智能合约，也不会修改智能合约；它的存在只是为了让一组复杂的、带有触发条件的数字化承诺能够按照参与者的意志，正确执行。

基于区块链的智能合约构建及执行分为如下几步：  
**步骤1 多方用户共同参与制定一份智能合约**
  1. 首先用户必须先注册成为区块链的用户，区块链返回给用户一对公钥和私钥；公钥做为用户在区块链上的账户地址，私钥做为操作该账户的唯一钥匙。  
  2. 两个以两个以上的用户根据需要，共同商定了一份承诺，承诺中包含了双方的权利和义务；这些权利和义务以电子化的方式，编程机器语言；参与者分别用各自私钥进行签名；以确保合约的有效性。  
  3. 签名后的智能合约，将会根据其中的承诺内容，传入区块链网络中。  

**步骤2 合约通过P2P网络扩散并存入区块链**
  1. 合约通过P2P的方式在区块链全网中扩散，每个节点都会收到一份；区块链中的验证节点会将收到的合约先保存到内存中，等待新一轮的共识时间，触发对该份合约的共识和处理。  
  2. 共识时间到了，验证节点会把最近一段时间内保存的所有合约，一起打包成一个合约集合（set），并算出这个合约集合的Hash值，最后将这个合约集合的Hash值组装成一个区块结构，扩散到全网；其它验证节点收到这个区块结构后，会把里面包含的合约集合的Hash取出来，与自己保存的合约集合进行比较；同时发送一份自己认可的合约集合给其它的验证节点；通过这种多轮的发送和比较；所有的验证节点最终在规定的时间内对最新的合约集合达成一致。  
  3. 最新达成的合约集合会以区块的形式扩散到全网，如下图所示，每个区块包含以下信息：当前区块的Hash值、前一区块的Hash值、达成共识时的时间戳、以及其它描述信息；同时区块链最重要的信息是带有一组已经达成共识的合约集；收到合约集的节点，都会对每条合约进行验证，验证通过的合约才回最终写入区块链中，验证的内容主要是合约参与者的私钥签名是否与账户匹配。

**步骤3 区块链构建的智能合约自动执行**
  1. 智能合约会定期检查自动机状态，逐条遍历每个合约内包含的状态机、事务以及触发条件；将条件满足的事务推送到待验证的队列中，等待共识；未满足触发条件的事务将继续存放在区块链上。  
  2. 进入最新轮验证的事务，会扩散到每一个验证节点，与普通区块链交易或事务一样，验证节点首先进行签名验证，确保事务的有效性；验证通过的事务会进入待共识集合，等大多数验证节点达成共识后，事务会成功执行并通知用户。  
  3. 事务执行成功后，智能合约自带的状态机会判断所属合约的状态，当合约包括的所有事务都顺序执行完后，状态机会将合约的状态标记为完成，并从最新的区块中移除该合约；反之将标记为进行中，继续保存在最新的区块中等待下一轮处理，直到处理完毕；整个事务和状态的处理都由区块链底层内置的智能合约系统自动完成，全程透明、不可攥改。

请参考出处：[《区块链：从数字货币到信用社会》](http://book.8btc.com/books/6/blockchain-credit/_book/)
